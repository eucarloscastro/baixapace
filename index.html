<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calculadora de Pace — Baixa Pace</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Blinker:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{ --red:#d42f2f; --border:#e7e7e7; --muted:#555; --text:#141414; }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:'Blinker',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial,sans-serif; color:var(--text); background:#fafafa; }
    .wrap{ max-width:880px; margin:40px auto; padding:24px }
    .card{ background:#fff; border:1px solid var(--border); border-radius:18px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.06) }
    h1{ font-size:clamp(22px,2.4vw,28px); margin:0 0 6px; font-weight:700; letter-spacing:.2px }
    .sub{ color:var(--muted); margin:0 0 16px }
    .topbar{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin:6px 0 16px }
    .badge{ font-size:12px; font-weight:700; padding:6px 10px; border-radius:999px; background:#fff; border:1px solid var(--border) }
    .btn{ font-weight:700; border:1px solid var(--border); background:#fff; padding:10px 14px; border-radius:12px; cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,.06) }
    .btn.primary{ background:var(--red); color:#fff; border-color:transparent }
    .btn[disabled]{ opacity:.5; cursor:not-allowed; box-shadow:none }
    .seg{ display:flex; background:#f3f3f3; border-radius:12px; padding:4px; gap:4px }
    .seg button{ padding:10px 14px; background:#fff; border:1px solid var(--border); border-radius:999px; font-weight:700; font-size:14px; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,.05) }
    .seg button[aria-pressed="true"]{ background:var(--red); color:#fff; box-shadow:0 4px 12px rgba(212,47,47,.35) }

    .grid{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px }
    @media (max-width:880px){ .grid{ grid-template-columns:1fr } }

    .field{ position:relative }
    .label{ display:block; font-weight:700; margin:0 0 6px }
    .input{ width:100%; padding:16px; border-radius:12px; border:1px solid var(--border); font-size:18px; outline:none; transition:border-color .2s, box-shadow .2s; }
    .input:focus{ border-color:#c9c9c9; box-shadow:0 0 0 4px rgba(0,0,0,.05) }
    .note{ font-size:12px; color:var(--muted); margin-top:8px }

    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:14px }
    .foot{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-top:14px }
    .resumo{ font-size:12px; color:var(--muted); margin-top:8px }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Calculadora de Pace</h1>
      <p class="sub"><b>Preencha dois campos</b> — e clique em <b>Calcular</b> que eu preencho o terceiro 😉</p>

      <div class="topbar">
        <span class="badge">Presets:</span>
        <button class="btn" data-preset="5">5K</button>
        <button class="btn" data-preset="10">10K</button>
        <button class="btn" data-preset="21.097">21K</button>
        <button class="btn" data-preset="42.195">42K</button>
      </div>

      <div class="grid">
        <div class="field">
          <label for="tempo" class="label">Tempo (hh:mm:ss)</label>
          <input id="tempo" class="input" type="text" inputmode="numeric" placeholder="02:59:20" autocomplete="off">
          <div class="note">Aceita <b>mm:ss</b> (ex.: 45:30) ou minutos (ex.: 105).</div>
        </div>
        <div class="field">
          <label for="dist" class="label">Distância</label>
          <input id="dist" class="input" type="text" inputmode="decimal" placeholder="42,195">
        </div>
        <div class="field">
          <label for="pace" class="label">Pace (min/uni)</label>
          <input id="pace" class="input" type="text" inputmode="numeric" placeholder="04:30" autocomplete="off">
          <div class="note">Formato <b>mm:ss</b> (ex.: 05:15 por km/mi).</div>
        </div>
      </div>

      <div class="row">
        <button class="btn primary" id="calcBtn" disabled>Calcular</button>
        <button class="btn" id="igBtn">Compartilhar no Instagram</button>
        <button class="btn" id="dlBtn">Baixar imagem</button>
        <button class="btn" id="clearBtn">Limpar</button>
      </div>

      <div class="foot">
        <span class="badge">Unidade:</span>
        <div class="seg" id="unitSeg">
          <button type="button" data-unit="km" aria-pressed="true">km</button>
          <button type="button" data-unit="mi" aria-pressed="false">mi</button>
        </div>
      </div>

      <p class="resumo" id="resumo">—</p>
    </div>
  </div>

  <script>
  (function(){
    const KM_PER_MI = 1.60934;

    const elTempo = document.getElementById('tempo');
    const elDist  = document.getElementById('dist');
    const elPace  = document.getElementById('pace');
    const unitSeg = document.getElementById('unitSeg');
    const resumo  = document.getElementById('resumo');
    const btnCalc = document.getElementById('calcBtn');
    const btnIG   = document.getElementById('igBtn');
    const btnDL   = document.getElementById('dlBtn');

    let unit = 'km';

    // util
    function inIframe(){ try{return window.top!==window.self}catch(_){return true;} }
    function isiOS(){ return /iP(ad|hone|od)/i.test(navigator.userAgent); }

    function normNumber(s){
      if(!s) return NaN;
      const v=(''+s).trim().replace(/\./g,'').replace(',', '.');
      const n=Number(v);
      return isFinite(n)?n:NaN;
    }
    function formatPt(n,dec=3){
      return n.toFixed(dec).replace(/\.?0+$/,'').replace('.',',');
    }

    function parseTime(v){
      if(!v) return NaN; v=(''+v).trim();
      if(/^\d+(:\d{1,2}){0,2}$/.test(v)){
        const p=v.split(':').map(Number);
        if(p.length===3) return p[0]*3600+p[1]*60+p[2];
        if(p.length===2) return p[0]*60+p[1];
        if(p.length===1) return p[0]*60;
      }
      if(/^\d+(\.\d+)?$/.test(v)) return Number(v)*60;
      return NaN;
    }
    function fmtTime(sec){
      if(!isFinite(sec)) return '';
      sec=Math.max(0,Math.round(sec));
      const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60;
      return h>0? `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}` : `${m}:${String(s).padStart(2,'0')}`;
    }
    const parsePace = parseTime;
    function fmtPace(sec){
      if(!isFinite(sec)) return '';
      sec=Math.max(0,Math.round(sec));
      const m=Math.floor(sec/60), s=sec%60;
      return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }

    function isTempo(){ return isFinite(parseTime(elTempo.value)); }
    function isDist(){ const d=normNumber(elDist.value); return isFinite(d)&&d>0; }
    function isPace(){ return isFinite(parsePace(elPace.value)); }
    function countValid(){ return (isTempo()?1:0)+(isDist()?1:0)+(isPace()?1:0); }

    function updateResumo(){
      const t=parseTime(elTempo.value), d=normNumber(elDist.value), p=parsePace(elPace.value);
      const parts=[];
      if(isFinite(t)) parts.push(`Tempo: ${fmtTime(t)}`);
      if(isFinite(d)) parts.push(`Distância: ${formatPt(d,2)} ${unit}`);
      if(isFinite(p)) parts.push(`Pace: ${fmtPace(p)} /${unit}`);
      resumo.textContent = parts.length? parts.join(' • ') : '—';
    }
    function updateCalcButton(){ btnCalc.disabled = (countValid()!==2); }

    // máscaras leves (sem zero automático)
    function maskTempo(){
      let d=elTempo.value.replace(/\D/g,'').slice(0,6), out='';
      if(d.length>=5) out=d.slice(0,-4)+':'+d.slice(-4,-2)+':'+d.slice(-2);
      else if(d.length>=3) out=d.slice(0,-2)+':'+d.slice(-2);
      else out=d;
      elTempo.value=out;
    }
    function maskPace(){
      let d=elPace.value.replace(/\D/g,'').slice(0,4);
      elPace.value = (d.length>=3)? d.slice(0,-2)+':'+d.slice(-2) : d;
    }
    function canonTempo(){ const t=parseTime(elTempo.value); if(isFinite(t)) elTempo.value=fmtTime(t); }
    function canonPace(){ const p=parsePace(elPace.value); if(isFinite(p)) elPace.value=fmtPace(p); }

    elTempo.addEventListener('input', ()=>{ maskTempo(); updateCalcButton(); updateResumo(); });
    elTempo.addEventListener('blur',  ()=>{ canonTempo(); updateCalcButton(); updateResumo(); });
    elPace .addEventListener('input', ()=>{ maskPace();  updateCalcButton(); updateResumo(); });
    elPace .addEventListener('blur',  ()=>{ canonPace(); updateCalcButton(); updateResumo(); });
    elDist .addEventListener('input', ()=>{ updateCalcButton(); updateResumo(); });

    [elTempo,elDist,elPace].forEach(el=>{
      el.addEventListener('keydown',e=>{ if(e.key==='Enter' && !btnCalc.disabled){ e.preventDefault(); btnCalc.click(); }});
    });

    // presets
    document.querySelectorAll('[data-preset]').forEach(b=>b.addEventListener('click',()=>{
      const km=Number(b.dataset.preset);
      const dist = unit==='mi' ? (km/KM_PER_MI) : km;
      elDist.value = formatPt(dist);
      updateCalcButton(); updateResumo();
    }));

    // unidade no rodapé
    unitSeg.addEventListener('click', e=>{
      const btn=e.target.closest('button[data-unit]'); if(!btn) return;
      const nu=btn.dataset.unit; if(nu===unit) return;
      [...unitSeg.querySelectorAll('button')].forEach(b=>b.setAttribute('aria-pressed', b===btn?'true':'false'));
      const d=normNumber(elDist.value), p=parsePace(elPace.value);
      if(isFinite(d)) elDist.value=formatPt(nu==='mi'? d/KM_PER_MI : d*KM_PER_MI);
      if(isFinite(p)) elPace.value=fmtPace(nu==='mi'? p*KM_PER_MI : p/KM_PER_MI);
      unit=nu; updateCalcButton(); updateResumo();
    });

    // calcular (só com 2 válidos)
    btnCalc.addEventListener('click', ()=>{
      const tHas=isTempo(), dHas=isDist(), pHas=isPace();
      if((tHas?1:0)+(dHas?1:0)+(pHas?1:0)!==2){ alert('Preencha exatamente dois campos'); return; }
      const t=parseTime(elTempo.value), d=normNumber(elDist.value), p=parsePace(elPace.value);
      if(!tHas && dHas && pHas)      elTempo.value=fmtTime(d*p);
      else if(!pHas && tHas && dHas) elPace.value =fmtPace(t/d);
      else if(!dHas && tHas && pHas) elDist.value =formatPt(t/p);
      updateCalcButton(); updateResumo();
    });

    // imagem para stories
    async function makeStoryBlob(){
      const W=1080,H=1920,p=60, canvas=document.createElement('canvas'); canvas.width=W; canvas.height=H;
      const ctx=canvas.getContext('2d');
      const bg1='#ffffff', bg2='#ffe9e9', fg='#141414', acc='#d42f2f';
      const g=ctx.createLinearGradient(0,0,W,H); g.addColorStop(0,bg1); g.addColorStop(1,bg2);
      ctx.fillStyle=g; ctx.fillRect(0,0,W,H); await document.fonts.ready;

      const text = resumo.textContent && resumo.textContent!=='—'
        ? resumo.textContent
        : 'Preencha dois campos e clique em Calcular para gerar seu resultado.';

      ctx.fillStyle=fg;
      ctx.font='700 56px Blinker, sans-serif'; ctx.fillText('Baixa Pace®', p, p+20);
      ctx.font='700 72px Blinker, sans-serif'; ctx.fillText('Calculadora de Pace', p, p+140);
      ctx.font='600 54px Blinker, sans-serif';
      const lines=(t=>{const w=t.split(' '),o=[];let l='';for(const x of w){const test=l?l+' '+x:x;if(ctx.measureText(test).width<=W-p*2){l=test}else{o.push(l);l=x}}if(l)o.push(l);return o;})(text);
      let y=p+260; for(const l of lines){ ctx.fillText(l,p,y); y+=76; }
      ctx.font='400 40px Blinker, sans-serif'; ctx.fillStyle=acc;
      ctx.fillText('Compartilhe seu tempo e marque @baixapace', p, H-p);

      return new Promise(res=> canvas.toBlob(b=>res(b),'image/jpeg',0.95));
    }

    function blobToDataURL(blob){
      return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(blob); });
    }

    // compartilhar: tenta Web Share; se bloqueado no iframe, abre a imagem em nova aba
    btnIG.addEventListener('click', async ()=>{
      try{
        const blob = await makeStoryBlob();
        const file = new File([blob],'pace-story.jpg',{type:'image/jpeg'});
        if(navigator.canShare && navigator.canShare({ files:[file] })){
          await navigator.share({ files:[file], title:'Calculadora de Pace — Baixa Pace', text:'Meu resultado na Calculadora de Pace' });
        }else{
          const url = await blobToDataURL(blob);
          window.open(url,'_blank'); // no iOS a pessoa toca “Salvar Imagem” (vai para Fotos)
        }
      }catch(e){}
    });

    // baixar: no iOS, nova aba (Salvar Imagem). No resto, download direto.
    btnDL.addEventListener('click', async ()=>{
      try{
        const blob = await makeStoryBlob();
        if(isiOS()){
          const url = await blobToDataURL(blob);
          window.open(url,'_blank');
        }else{
          const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='pace-story.jpg';
          document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
        }
      }catch(e){}
    });

  })();
  </script>
</body>
</html>